# Context & Problem
After running `npx collie init`, the generated project’s `vite.config.ts` is being modified into:

```ts
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import collie from "@collie-lang/vite";

// https://vite.dev/config/
export default defineConfig({
  plugins: [ collie(), react()],
})
```

There are three issues (least → most important):

1. Formatting: extra space after `[` in `plugins: [ collie()...`
2. Ordering: `collie()` is inserted before `react()`. Desired: `react()` first.
3. Critical: TypeScript error: `No overload matches this call ... Plugin<any> is not assignable to PluginOption ...` due to duplicate Vite/Rollup type universes (the plugin’s `Plugin` types resolve from one physical `vite`/`rollup`, while the template resolves from another). Runtime “mostly works”, but TS is broken.

The end state must be both cosmetically correct and type-correct.

# Scope

You may modify any repo code needed (CLI, plugin package, templates, docs), but keep changes minimal and focused on fixing init output + the TS type mismatch properly.

# Do NOT write tests

Do NOT add, modify, or regenerate tests. Do NOT change tests to “make it pass”.

# Instructions

## Part 1 — Fix init’s `vite.config.ts` patching (robust formatting + ordering + idempotency)

1. Locate where `npx collie init` modifies `vite.config.ts` (likely `packages/cli/**`).
2. Replace any brittle regex/string-splice logic with an AST-based transformer so the output is deterministic and idempotent.

Implementation requirements:

* Use TypeScript compiler API or `ts-morph` (prefer whichever is already present in the repo; add a new dependency only if it materially reduces risk).
* Parse `vite.config.ts` as TS source.
* Ensure an import exists: `import collie from "@collie-lang/vite";`

  * Preserve existing quote style if possible; but acceptance criteria below includes that exact import line, so match it.
* Find the default export `defineConfig({ ... })` call.
* Ensure there is a `plugins` property within the config object; create it if absent.
* Ensure `plugins` is an array literal.
* Ensure `react()` appears before `collie()` and `collie()` is last.
* Ensure both appear exactly once.
* Ensure there is no weird whitespace introduced (especially no `[ collie()` spacing).
* Preserve the project’s newline style (LF/CRLF) and avoid rewriting unrelated parts of the file.

Idempotency:

* Running `collie init` twice must not duplicate imports or plugins.
* If other plugins exist, preserve their relative order; only enforce `react()` comes before `collie()` and `collie()` is last.

  * Example: `[react(), otherPlugin(), collie()]` is acceptable.
  * If `react()` isn’t found, do not invent it; only ensure `collie()` is last among existing plugins.

## Part 2 — Fix the TypeScript mismatch “for real” (no overrides band-aid)

The root cause is that `@collie-lang/vite` is producing/returning a plugin typed against a different physical `vite`/`rollup` instance than the consuming project, leading to private-type incompatibilities (e.g. `_pluginContextMap`).

Fix strategy (the correct one):

1. In `packages/vite` (the `@collie-lang/vite` package), change dependency posture so consumers provide Vite:

   * `vite` must be a `peerDependency` (and also a `devDependency` for local build/typecheck).
   * If `rollup` is directly depended on for types/runtime, ensure it does NOT end up as a second copy in consumers. Prefer relying on Vite’s rollup types via Vite, and avoid direct rollup dependency unless required.
   * Remove `vite` from `dependencies` if it’s currently there (or otherwise stop it from being installed as a nested dependency of the plugin).
   * If you must keep `vite` in `dependencies` for runtime (unlikely for a Vite plugin), document why; but prefer peerDependencies.

2. Align versions:

   * Ensure template(s) generated by `collie init` specify a Vite version compatible with the plugin’s peer range.
   * Set a reasonable peer range (e.g. `^7.0.0` if you’re targeting Vite 7, or broader only if you’ve validated it).
   * Update any template package.json files and CLI scaffolding that pins Vite versions so the peer dependency is satisfied by default.

3. Ensure `collie()` is typed from the consumer’s Vite:

   * In plugin source, type imports should come from `'vite'` (the peer).
   * The exported function should return a type compatible with `PluginOption` expected by `defineConfig`.
   * Avoid `as any` type assertions; fix at the dependency/type level.

4. Validate locally in a realistic scenario:

   * `pnpm -C packages/vite build` (or equivalent)
   * `npx collie init` a fresh Vite+React project from the template
   * `pnpm install` in the generated project
   * Open TypeScript / run `pnpm lint` / `tsc --noEmit` and ensure there is no overload mismatch for `collie()`.

## Part 3 — Improve the init flow to prevent regressions

* If init writes/patches multiple files, isolate the Vite config patcher into its own module (pure transform preferred: `(text) => text`).
* Add clear CLI logging in `--verbose` mode showing what changed:

  * “Added @collie-lang/vite import”
  * “Inserted collie() plugin (last)”
  * “No change (already up to date)”
* If the config shape is unexpected (e.g. no `defineConfig`, plugins not an array), fail with a helpful error that explains what was expected and what was found.

# Acceptance Criteria

## A) Exact output shape in `vite.config.ts`

After running `npx collie init`, the generated project’s `vite.config.ts` must be:

```ts
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import collie from "@collie-lang/vite";

// https://vite.dev/config/
export default defineConfig({
  plugins: [react(), collie()],
})
```

Key requirements:

* No extra whitespace after `[`
* `react()` appears before `collie()`
* `collie()` is last in the array

## B) No TypeScript error on `collie()`

The generated project must have no TS overload/type mismatch for `collie()` in `vite.config.ts`.

* No “Plugin<any> is not assignable to PluginOption”
* No Vite/Rollup duplicate-type issues

## C) Idempotent init

Running `npx collie init` multiple times:

* must not duplicate the `collie` import
* must not duplicate `collie()` in plugins
* must not reorder unrelated plugins beyond enforcing `collie()` last and `react()` before it

## D) Minimal, maintainable changes

* Avoid massive rewrites. Refactor only what’s necessary to make the behavior reliable.
* No test changes.

# Additional Recommendations (Do if low-risk)

* Prefer a small AST patcher over Prettier formatting; do not auto-format the entire file.
* Preserve existing newline style.
* Use stable printing for the modified nodes only; avoid reprinting the whole file if possible.
* If you already have Prettier in templates, do not depend on it in the CLI at runtime; keep init deterministic without requiring extra tools.