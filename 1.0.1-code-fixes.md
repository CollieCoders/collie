# 1.0.1 Fixes (Collie Repo)

Complete: 0%

## Context & Problem

We are standardizing on the “Collie way” for class aliases:

```collie
#classes
  card-container = flex.flex-col...

CardHeader.$card-container
```

Right now the compiler/parser does not fully treat `#classes` as a real directive with proper block semantics, and it does not fully support kebab/snake alias names in both the alias declaration and `$alias` usage. This leads to cascading runtime diagnostics like indentation-jump errors, “element lines must start with…”, and undefined alias errors that truncate the alias name.

This doc defines the staged changes to make the compiler/runtime authoritative for the new syntax and improve build/dev-time correctness (especially around duplicate template IDs, since we’re allowing collisions across directories by design).

## Principles / Decisions

* `#classes` is the directive (not `classes`).
* Alias names in `#classes` support kebab-case (and snake_case): `card-container`, `card_container`.
* `$alias` usage supports kebab/snake: `.$card-container`, `.$card_container`.
* We do NOT add legacy support or “accept old syntax.” Any old syntax is simply invalid.
* Duplicate template IDs across the project are allowed to *exist* (edge case), but must produce strong, deterministic errors at dev/build time.

---

## Stage 1 — Compiler grammar: parse and format `#classes` correctly

Complete: 0%

### Goal

Make the compiler accept and correctly parse:

```collie
#classes
  card-container = flex.flex-col.items-start.gap-2

CardHeader.$card-container
```

…and avoid cascade errors for valid syntax.

### Files (expected)

* `packages/compiler/src/parser.ts`
* `packages/compiler/src/format.ts`

### Work

1. Update directive recognition

   * Replace any existing `classes` block handling with `#classes`.
   * Ensure `#classes` is only valid at the top level (same rule style as `#inputs`).

2. Block semantics

   * Inside `#classes`, parse each indented line as an alias definition.
   * Ensure indentation handling for this block prevents spurious “indentation jumped more than one level” cascades.

3. Formatter output

   * Ensure the formatter prints `#classes` as the directive header.

### Expected outcome

* `#classes` no longer triggers “Element lines must start…” or bogus indentation errors when syntactically correct.
* Formatting outputs `#classes`.

### Acceptance criteria

* A valid `#classes` block compiles without errors.
* If `#classes` is not at top level, the compiler produces one clear diagnostic for that rule (not a cascade).
* The formatter prints `#classes`.

---

## Stage 2 — Support kebab/snake alias names and kebab/snake `$alias` usage

Complete: 0%

### Goal

Allow:

* alias name: `card-container` / `card_container`
* usage: `.$card-container` / `.$card_container`

…and ensure diagnostics show the full alias name.

### Files (expected)

* `packages/compiler/src/parser.ts`

### Work

1. Alias definition name validation

   * Update the alias-name validation to allow:

     * starts with `[A-Za-z_]`
     * continues with `[A-Za-z0-9_-]*`
   * Keep it strict enough to avoid ambiguous parsing.

2. `$alias` token recognition in class lists

   * Update `$alias` matching so hyphen/underscore are allowed:

     * `$card-container`
   * Ensure tokenization does not split on `-`.

3. Undefined-alias diagnostics

   * Ensure the diagnostic message and span/range reflect the full alias name (no truncation to `card`).
   * The error should point to the `$card-container` token in the class list.

### Expected outcome

* Kebab/snake aliases work end-to-end.
* Undefined alias errors reference the full alias name and highlight the correct token.

### Acceptance criteria

* The example above compiles cleanly with aliases defined.
* Removing an alias produces a precise undefined-alias diagnostic targeting `$card-container`.

---

## Stage 3 — Dev/build: deterministic duplicate template ID detection

Complete: 0%

### Goal

Because we’re allowing filename collisions across directories by design, duplicate `#id` values may occur. Dev/build must fail fast with a deterministic, high-quality error that names both paths.

### Files (expected)

* `packages/vite/src/**` (template discovery/indexing)
* Any “template registry” / discovery runtime used by Vite integration

### Work

1. During template indexing/discovery, build a map:

   * `Map<templateId, { filePath: string }[]>`

2. When an id has more than one definition:

   * Emit a hard error during dev and build.
   * The message must include:

     * duplicate id
     * first file path
     * second file path (and ideally all paths if >2)
     * recommended action: rename one `#id` to be unique.

3. Determinism

   * Ensure file iteration order is stable (sort by path before indexing).
   * Ensure the “first” vs “second” in the error is consistent.

### Expected outcome

* Duplicate IDs are caught consistently across OS/filesystem watcher ordering.
* Errors are obvious and actionable.

### Acceptance criteria

* Two `.collie` files defining the same `#id` reliably fails dev/build.
* The error includes both file paths and the duplicate id.

---

## Stage 4 — Stabilize compiler diagnostic contract for inline text (for IDE quick-fix)

Complete: 0%

### Goal

The VS Code extension will offer a quick fix for inline text that must start with `|`. This stage ensures the compiler emits a stable, specific diagnostic code/message for that case.

### Files (expected)

* `packages/compiler/src/parser.ts`

### Work

1. Confirm/ensure the inline text rule uses a stable diagnostic code (e.g. `COLLIE004`).
2. Ensure the message remains stable and specific (avoid frequent rewording).
3. Ensure the diagnostic range points to the inline text token region.

### Expected outcome

* IDE can reliably match the inline-text diagnostic and apply a quick fix.

### Acceptance criteria

* Inline text that violates the rule produces the same diagnostic code and a consistent message.

---

## Notes / Non-goals (1.0.1)

* No legacy syntax support or migration logic.
* No converter behavior changes in this repo (handled in collie-vscode).
* No additional new DSL features beyond `#classes` + alias naming support required above.